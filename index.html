<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDA BACK MARKET | FULL RESTORATION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        :root { --brand: #f0b90b; --bg: #0b0e11; --card: #1e2329; --green: #2ebd85; --red: #f6465d; --gray: #848e9c; }
        body { background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 90px; font-size: 13px; line-height: 1.6; }
        
        .header { text-align: center; color: var(--brand); padding: 15px; border-bottom: 1px solid #333; font-weight: 900; font-size: 18px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #181a20; display: flex; justify-content: space-around; padding: 18px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { font-size: 10px; color: var(--gray); cursor: pointer; font-weight: 800; text-transform: uppercase; }

        .bank-details-grid { background: #1a1a00; border: 1px solid var(--brand); padding: 12px; border-radius: 6px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; }
        .bank-details-grid div b { color: var(--brand); display: block; text-transform: uppercase; font-size: 9px; }

        .slim-balance-header { display: flex; justify-content: space-between; align-items: center; background: #000; padding: 12px 20px; border-bottom: 1px solid var(--brand); }
        .slim-balance-header h2 { margin: 0; color: var(--brand); font-size: 20px; font-weight: 900; }
        .slim-balance-header small { color: var(--gray); font-size: 9px; text-transform: uppercase; }
        
        .card { background: var(--card); border-radius: 8px; padding: 15px; margin: 10px; border: 1px solid #333; }
        input, select { width: 100%; padding: 12px; margin: 6px 0; background: #2b3139; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; font-size: 14px; outline: none; }
        button { width: 100%; padding: 14px; background: var(--brand); color: #000; font-weight: 800; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; font-size: 13px; }
        .btn-red { background: var(--red); color: #fff; }
        .btn-green { background: var(--green); color: #fff; }
        .btn-secondary { background: #444; color: #fff; }
        
        .ad-item { background: #161a1e; padding: 12px; border-radius: 6px; border-left: 4px solid var(--brand); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--brand); color: #000; padding: 10px 25px; border-radius: 30px; font-weight: 800; z-index: 10001; display: none; }
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 12px; width: 85%; max-width: 380px; text-align: center; border: 1px solid var(--brand); }
        .hidden { display: none !important; }
        .legal-text { font-size: 11px; color: var(--gray); line-height: 1.6; text-align: justify; margin-top: 10px; }
    </style>
</head>
<body>

<div id="toast"></div>
<div id="modalOverlay"><div class="modal-content"><h3 id="modalTitle"></h3><p id="modalMsg"></p><button onclick="closeModal()">OK</button></div></div>

<h1 class="header" onclick="triggerAdmin()">SDA BACK MARKET</h1>

<div id="authPanel" class="card">
    <input type="number" id="uPhone" placeholder="Mobile Number">
    <input type="password" id="uPin" maxlength="4" placeholder="4-Digit PIN">
    <div id="signupFields" class="hidden">
        <input type="text" id="uQ" placeholder="Security Question">
        <input type="text" id="uA" placeholder="Answer">
    </div>
    <button onclick="authAction()">LOGIN / REGISTER</button>
    <div style="display:flex; justify-content: space-between; margin-top:20px; font-size:12px; font-weight:800; color:var(--brand); cursor:pointer;">
        <span onclick="document.getElementById('signupFields').classList.toggle('hidden')">NEW ACCOUNT</span>
        <span onclick="showSection('recoverPanel')">FORGOT PIN?</span>
    </div>
</div>

<div id="recoverPanel" class="card hidden">
    <input type="number" id="rPhone" placeholder="Phone">
    <input type="text" id="rA" placeholder="Security Answer">
    <button onclick="recoverPin()">REVEAL PIN</button>
    <button onclick="location.reload()" class="btn-secondary">BACK</button>
</div>

<div id="mainApp" class="hidden">
    <div id="homeView">
        <div class="slim-balance-header">
            <div><small>Receiving Balance</small><h2 id="walletBal">0.00 SDA</h2></div>
            <button onclick="showSection('withdrawSec')" style="width:auto; padding:8px 15px; font-size:10px;">WITHDRAW</button>
        </div>
        <div id="buyerActionAlerts"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; padding:10px;">
            <button onclick="showSection('postSec')" class="btn-green">SELL SDA</button>
            <button onclick="showSection('sellerSec')">SELLER HUB</button>
        </div>
        <div class="card"><h3>Live Marketplace</h3><div id="marketFeed"></div></div>
    </div>

    <div id="sellerSec" class="card hidden">
        <div class="card" style="border:1px dashed var(--brand); text-align:center;">
            <small>Selling Vault Address</small>
            <div id="vAddrDisp" style="font-size:10px; color:var(--brand); margin:12px 0; word-break:break-all;"></div>
            <button onclick="navigator.clipboard.writeText(myVault); notify('COPIED')">COPY ADDRESS</button>
            <div id="vBalDisp" style="margin-top:15px; font-weight:900;">Vault: 0.00 SDA</div>
        </div>
        <div id="sellerOrderAlerts"></div>
        <h4>My Ads & Stock</h4>
        <div id="myAds"></div>
    </div>

    <div id="buyPanel" class="card hidden">
        <div class="bank-details-grid" id="bankGrid"></div>
        <label style="font-size:10px; color:var(--brand); font-weight:bold;">QUANTITY:</label>
        <input type="number" id="bQty" oninput="updateBuyTotal()" placeholder="0.00">
        <div id="bTotal" style="color:var(--brand); font-size:28px; font-weight:900; margin:15px 0; text-align:center;">0 NGN</div>
        <p style="font-size:11px; color:var(--gray); font-weight:800; text-align:center;">PAYMENT PROOF:</p>
        <input type="text" id="bFromBank" placeholder="Sender Bank">
        <input type="text" id="bFromName" placeholder="Sender Name">
        <input type="number" id="bFromNum" placeholder="Sender Account Number">
        <button onclick="submitBuyProof()" class="btn-green">I HAVE PAID</button>
        <button onclick="showSection('homeView')" class="btn-secondary">CANCEL</button>
    </div>

    <div id="postSec" class="card hidden">
        <input type="number" id="pPrice" placeholder="Price (NGN)">
        <input type="number" id="pQty" placeholder="Quantity SDA">
        <input type="text" id="pBName" placeholder="Bank Name">
        <input type="number" id="pBAcc" placeholder="Account Number">
        <input type="text" id="pBHolder" placeholder="Account Name">
        <button onclick="postAd()" class="btn-green">PUBLISH</button>
    </div>

    <div id="withdrawSec" class="card hidden">
        <p class="legal-text">0.2% withdrawal fee applies.</p>
        <input type="text" id="wAddr" placeholder="Destination Address">
        <input type="number" id="wAmt" placeholder="Amount">
        <button onclick="processWithdraw()">WITHDRAW</button>
    </div>

    <div id="adminSec" class="card hidden">
        <h3 style="color:var(--red)">ADMIN CONSOLE</h3>
        <div class="card" style="background:#222;">
            <input type="number" id="admPhone" placeholder="Target Phone">
            <select id="admStatus">
                <option value="USER">ACTIVE</option>
                <option value="LOCKED">LOCK USER</option>
                <option value="BANNED">BAN USER</option>
            </select>
            <button onclick="adminUserAction()">UPDATE STATUS</button>
        </div>
        <div id="adminFeed"></div>
    </div>

    <div id="aboutSec" class="card hidden">
        <h3>About SDA Back Market</h3>
        <p class="legal-text">SDA Back Market is a specialized P2P bridge for the Sidra Chain community. We provide a non-custodial environment where buyers and sellers can exchange SDA for fiat with blockchain-backed security. Our escrow system ensures that SDA is locked in a vault until the seller confirms payment or a dispute is resolved.</p>
    </div>
    <div id="privacySec" class="card hidden">
        <h3>Privacy Policy</h3>
        <p class="legal-text">Your private keys never leave your device. We store them in your browser's local encrypted storage. We do not track personal identity beyond your mobile number for account routing. You are responsible for backing up your security answer.</p>
    </div>
    <div id="tosSec" class="card hidden">
        <h3>Terms & Conditions</h3>
        <p class="legal-text">1. Commissions: Sellers are charged a 0.5% marketplace fee upon successful release. <br>2. Withdrawals: A 0.2% fee applies to transfers to external addresses. <br>3. Compliance: Any attempt to spoof bank proofs or manipulate the system will result in an immediate BAN and vault LOCK. <br>4. Exact Delivery: Buyers must receive the exact amount of SDA they paid for.</p>
    </div>
</div>

<div id="navBar" class="nav-bar hidden">
    <div class="nav-item" onclick="showSection('homeView')">MARKET</div>
    <div class="nav-item" onclick="showSection('aboutSec')">ABOUT</div>
    <div class="nav-item" onclick="showSection('privacySec')">PRIVACY</div>
    <div class="nav-item" onclick="showSection('tosSec')">TERMS</div>
    <div class="nav-item" onclick="logout()" style="color:var(--red)">LOGOUT</div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw6NgqciWredwJBBR8Mgkl6pRlIk1KECJtP-H6u9aeZ78Uk1NcOjV7DgRW1Vwk_LHdyOg/exec"; 
    const ADMIN_WALLET = "0x0141F9569B652BD1740fb4d99889dA7a600d4c5F";
    const RPC = "https://node.sidrachain.com";
    
    let curU = localStorage.getItem('s_u'), myVault = localStorage.getItem('s_v'), myVKey = localStorage.getItem('s_vk');
    let myBuyAddr = localStorage.getItem('s_ba'), myBuyKey = localStorage.getItem('s_bk');
    let actP = 0, actV = "", actS = 0, hits = 0;

    if(curU) startApp();

    function notify(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=> t.style.display='none', 3000); }
    function openModal(t, m) { document.getElementById('modalTitle').innerText = t; document.getElementById('modalMsg').innerText = m; document.getElementById('modalOverlay').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    async function authAction() {
        const isSignup = !document.getElementById('signupFields').classList.contains('hidden');
        const v = ethers.Wallet.createRandom(), b = ethers.Wallet.createRandom();
        const res = await fetch(GAS_URL, {method:"POST", body:JSON.stringify({
            action:"auth", phone: document.getElementById('uPhone').value, pin: document.getElementById('uPin').value,
            isSignup, question: document.getElementById('uQ').value, answer: document.getElementById('uA').value,
            vault: v.address, vKey: v.privateKey, buyAddr: b.address, buyKey: b.privateKey
        })});
        const txt = await res.text();
        if(["EXISTS", "NOT_FOUND", "WRONG_PIN", "BANNED", "LOCKED"].includes(txt)) openModal("AUTH ERROR", txt);
        else {
            const d = isSignup ? {vault: v.address, vKey: v.privateKey, buyAddr: b.address, buyKey: b.privateKey} : JSON.parse(txt);
            localStorage.setItem('s_u', document.getElementById('uPhone').value);
            localStorage.setItem('s_v', d.vault); localStorage.setItem('s_vk', d.vKey);
            localStorage.setItem('s_ba', d.buyAddr); localStorage.setItem('s_bk', d.buyKey);
            location.reload();
        }
    }

    async function recoverPin() {
        const res = await fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"recover", phone: document.getElementById('rPhone').value, answer: document.getElementById('rA').value})});
        const txt = await res.text(); openModal("RECOVERY", txt === "INVALID" ? "Wrong Answer" : "PIN: " + txt);
    }

    async function postAd() {
        const p = new ethers.JsonRpcProvider(RPC);
        const bal = await p.getBalance(myVault);
        if (parseFloat(ethers.formatEther(bal)) <= 0) { openModal("EMPTY", "Fund Vault."); return; }
        await fetch(GAS_URL, {method:"POST", body:JSON.stringify({
            action: "postAd", sellerPhone: curU, vault: myVault,
            price: document.getElementById('pPrice').value, qty: document.getElementById('pQty').value,
            bName: document.getElementById('pBName').value, bAcc: document.getElementById('pBAcc').value,
            bHolder: document.getElementById('pBHolder').value
        })});
        notify("LIVE"); showSection('homeView');
    }

    async function sync() {
        if(!curU) return;
        const p = new ethers.JsonRpcProvider(RPC);
        try {
            const bBal = await p.getBalance(myBuyAddr);
            const vBal = await p.getBalance(myVault);
            document.getElementById('walletBal').innerText = parseFloat(ethers.formatEther(bBal)).toFixed(4) + " SDA";
            document.getElementById('vBalDisp').innerText = "Vault: " + parseFloat(ethers.formatEther(vBal)).toFixed(4) + " SDA";
        } catch(e) {}
        const res = await fetch(GAS_URL); const d = await res.json();
        renderMarket(d.ads); renderSeller(d.ads, d.users); renderBuyer(d.ads);
        renderAdmin(d.ads, d.users);
    }

    function renderMarket(ads) {
        let h = "";
        for(let i=1; i < ads.length; i++) {
            if(ads[i][8] === "ACTIVE" && parseFloat(ads[i][3]) > 0.0001) {
                h += `<div class="ad-item"><div><b>${ads[i][2]} NGN</b><br><small>Stock: ${ads[i][3]}</small></div>
                <button onclick="openBuy('${ads[i][4]}','${ads[i][2]}','${ads[i][3]}','${ads[i][5]}','${ads[i][6]}','${ads[i][7]}')" style="width:70px;">BUY</button></div>`;
            }
        }
        document.getElementById('marketFeed').innerHTML = h || "No Ads.";
    }

    function openBuy(v, p, s, bn, ba, bh) {
        actV = v; actP = p; actS = s; showSection('buyPanel');
        document.getElementById('bankGrid').innerHTML = `<div><b>Bank</b>${bn}</div><div><b>Acc #</b>${ba}</div><div style="grid-column:span 2"><b>Name</b>${bh}</div>`;
    }

    function updateBuyTotal() {
        let qEl = document.getElementById('bQty'), q = qEl.value;
        if(parseFloat(q) > parseFloat(actS)) { notify("MAX: " + actS); q = actS; qEl.value = q; }
        document.getElementById('bTotal').innerText = (q * actP).toLocaleString() + " NGN";
    }

    async function submitBuyProof() {
        const qVal = document.getElementById('bQty').value;
        if(!document.getElementById('bFromBank').value) { notify("ENTER BANK"); return; }
        const res = await fetch(GAS_URL, {method:"POST", body:JSON.stringify({
            action:"submitProof", vault: actV, buyerPhone: curU, reqQty: qVal, 
            fromBank: document.getElementById('bFromBank').value, fromName: document.getElementById('bFromName').value, fromNum: document.getElementById('bFromNum').value
        })});
        const txt = await res.text();
        if(txt === "EXCEEDS_STOCK") { openModal("ERROR", "Stock changed."); sync(); }
        else { notify("PROOFS SENT"); showSection('homeView'); }
    }

    function renderSeller(ads, users) {
        let h = "", a = "";
        for(let i=1; i < ads.length; i++) {
            if(ads[i][1] == curU && ads[i][8] !== "SOLD") {
                if(ads[i][8] === "PENDING_CONFIRMATION") {
                    const parts = ads[i][9].split(" | ");
                    const reqQty = parts[1].split(":")[1];
                    const bPhone = parts[0].split(":")[1];
                    const bU = users.find(u => u[0] == bPhone);
                    a += `<div class="card" style="border:1px solid var(--green)"><b>ORDER: ${reqQty} SDA</b><br><small>${ads[i][9]}</small>
                        <button onclick="releaseSDA('${myVKey}','${reqQty}','${ads[i][4]}','${bU[7]}')">RELEASE</button></div>`;
                }
                // --- PRICE EDITING UI (FIXED) ---
                h += `<div class="ad-item"><div><b>STOCK: ${ads[i][3]}</b><br><small>${ads[i][2]} NGN</small></div>
                <div style="display:flex; gap:5px;"><input type="number" id="ep_${i}" placeholder="New Price" style="width:70px; padding:5px; margin:0;"><button onclick="editPrice('${ads[i][4]}', document.getElementById('ep_${i}').value)" style="width:40px; padding:5px; margin:0; background:var(--brand); color:#000;">SET</button></div></div>`;
            }
        }
        document.getElementById('sellerOrderAlerts').innerHTML = a;
        document.getElementById('myAds').innerHTML = h;
    }

    function renderBuyer(ads) {
        let h = "";
        for(let i=1; i < ads.length; i++) {
            if(ads[i][8] === "PENDING_CONFIRMATION" && ads[i][9].includes("BUYER:" + curU)) {
                h += `<div class="card" style="border:1px solid var(--red)">Waiting for Seller...<br><button style="background:none; color:red; border:none; margin-top:5px; font-weight:800;" onclick="dispute('${ads[i][4]}')">DISPUTE</button></div>`;
            }
        }
        document.getElementById('buyerActionAlerts').innerHTML = h;
    }

    async function releaseSDA(vk, q, va, ba) {
        notify("RELEASING...");
        const p = new ethers.JsonRpcProvider(RPC), w = new ethers.Wallet(vk, p);
        const exactQty = parseFloat(q);
        const commission = exactQty * 0.005; 
        try {
            await w.sendTransaction({to: ba, value: ethers.parseEther(exactQty.toFixed(6))});
            await w.sendTransaction({to: ADMIN_WALLET, value: ethers.parseEther(commission.toFixed(6))});
            await fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"updateStatus", vault:va, soldQty: q})});
            notify("SUCCESS"); sync();
        } catch(e) { openModal("ERROR", "Check Vault SDA for fees."); }
    }

    // --- REAL-TIME PRICE EDITING FUNCTION (FIXED) ---
    async function editPrice(v, p) {
        if(!p || p <= 0) { notify("ENTER VALID PRICE"); return; }
        notify("UPDATING PRICE...");
        const res = await fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"editPrice", vault:v, newPrice:p})});
        const txt = await res.text();
        if(txt === "PRICE_UPDATED") { notify("PRICE SET TO " + p); sync(); }
        else { openModal("FAILED", txt); }
    }

    async function dispute(v) { await fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"raiseDispute", vault:v})}); notify("DISPUTED"); sync(); }

    async function adminUserAction() {
        const ph = document.getElementById('admPhone').value;
        const st = document.getElementById('admStatus').value;
        await fetch(GAS_URL, {method:"POST", body:JSON.stringify({action:"adminAction", targetPhone: ph, newStatus: st})});
        notify("USER " + st); sync();
    }

    function renderAdmin(ads, users) {
        let h = "";
        for(let i=1; i < ads.length; i++) {
            if(ads[i][8] === "DISPUTED") {
                const parts = ads[i][9].split(" | ");
                const bPhone = parts[0].split(":")[1];
                const reqQty = parts[1].split(":")[1];
                const bU = users.find(u => u[0] == bPhone);
                const sU = users.find(u => u[0] == ads[i][1]);
                h += `<div class="ad-item"><b>DISPUTE: ${reqQty}</b><br><small>Buyer: ${bPhone}</small>
                    <button onclick="releaseSDA('${sU[6]}','${reqQty}','${ads[i][4]}','${bU[7]}')" class="btn-red">FORCE</button></div>`;
            }
        }
        document.getElementById('adminFeed').innerHTML = h || "No Disputes.";
    }

    async function processWithdraw() {
        const p = new ethers.JsonRpcProvider(RPC), w = new ethers.Wallet(myBuyKey, p);
        const amt = parseFloat(document.getElementById('wAmt').value), fee = amt * 0.002; 
        try {
            await w.sendTransaction({to: ADMIN_WALLET, value: ethers.parseEther(fee.toFixed(6))});
            await w.sendTransaction({to: document.getElementById('wAddr').value, value: ethers.parseEther((amt-fee).toFixed(6))});
            notify("DONE"); sync();
        } catch(e) { openModal("FAILED", "Check Bal."); }
    }

    function triggerAdmin() { hits++; if(hits >= 10) { notify("ADMIN ON"); showSection('adminSec'); } }
    function showSection(id) { document.querySelectorAll('#mainApp > div, #authPanel, #recoverPanel').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function logout() { localStorage.clear(); location.reload(); }
    function startApp() { document.getElementById('authPanel').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden'); document.getElementById('navBar').classList.remove('hidden'); document.getElementById('vAddrDisp').innerText = myVault; sync(); setInterval(sync, 10000); }
</script>
</body>
</html>